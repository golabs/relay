# Explanation of `.claude/TASK.md`

## What This File Does

This document is a detailed planning blueprint for adding a second person to the Relay chat system while keeping their work completely separate from the first person's work. Think of it like designing an apartment building where two tenants each get their own private apartment with their own furniture and belongings, but the building superintendent (administrator) has a master key to access both apartments when needed. The document explores four different architectural approaches for accomplishing this, analyzes the pros and cons of each, and recommends the best solution - but importantly, this is purely a planning document with no actual implementation happening yet. It's the "think before you build" phase where all the important decisions get mapped out before anyone starts changing code or systems.

## Key Components

**Overview and User Story**: Sets the stage by explaining that the system currently has one user (with a long 25-character username) who will become the administrator, and needs to add a second user (with a short 6-character username "xfg6gb"). The goal is to let both work independently while the admin can see everything.

**Requirements Section (Three Categories)**: Breaks down what the system must do:
- **User Configuration**: How to identify each user and mark one as administrator, plus the unusual requirement that both share the same login credentials (SSH keys)
- **Project Isolation**: Each user gets their own folder for projects (like separate filing cabinets), with regular users seeing only their own work but the admin seeing everything
- **Relay UI Integration**: The chat interface needs to filter what's visible based on who's logged in, with clear indication of which user is active

**Acceptance Criteria**: A checklist of what a successful plan must include - it must explain authentication, folder organization, UI changes, identify specific files needing modification, consider edge cases (unusual situations that could cause problems), estimate difficulty, and most importantly, emphasize that this is planning only with no code being written.

**Technical Considerations - Current System State**: Documents what exists right now - one user, projects stored in `/opt/clawd/projects/`, server runs on port 7786, and authentication uses SSH keys.

**Key Questions to Address**: Five critical questions that must be answered:
1. **User Identity Storage**: How does the system know which user is active? (environment variable, config file, browser cookie, or URL parameter?)
2. **Project Discovery & Filtering**: How to scan for projects and show only the right ones to each user?
3. **Access Control Model**: How to mark someone as an administrator and enforce "you can only see your own projects"?
4. **User Switching**: Do users run on the same computer account or separate accounts? How do they switch between user contexts?
5. **Session Management**: If users switch contexts in the same browser, how does the system remember who's who?

**Four Potential Approaches**: This is the heart of the analysis - four completely different ways to solve the problem, each with detailed pros and cons:

- **Option A (Environment Variable + Project Subdirectories)**: Set a special computer setting that says "I'm user A" or "I'm user B" before starting Relay. Projects organized in separate folders. Simple but requires running two separate instances of Relay.

- **Option B (User Selector in Relay UI)**: Add a dropdown menu in the interface where users pick who they are. Single Relay instance, easy switching, but no real security (honor system).

- **Option C (OS-Level User Accounts)**: Create completely separate computer user accounts for each person, each running their own Relay on different ports (like 7786 and 7787). True isolation but more complex setup.

- **Option D (Single User, Project Metadata Tags)**: Keep everything as-is but add a small file in each project folder that says "this belongs to user X." Minimal changes but requires maintaining those metadata files.

**Files Likely Requiring Changes**: Lists five specific files/areas that would probably need modifications:
1. `relay/config.py` - configuration settings
2. `relay/api_handlers.py` - project discovery and filtering logic
3. `relay/templates/index.html` - user interface additions
4. `relay/templates/app.js` - frontend filtering and user switching
5. Environment/Deployment files - startup scripts and service configurations

**Edge Cases & Security Considerations**: Lists potential problems to watch for, like "Can someone hack the URL to see projects they shouldn't?" or "What happens if both users create a project with the same name?" or "Both users share the same credentials - how do we prevent accidental cross-contamination?"

**Recommended Approach (Hybrid)**: After analyzing all options, the document recommends a "Hybrid" solution (essentially Option A with clear admin privileges):
- Use an environment variable to identify which user is running Relay
- Organize projects into user-specific subdirectories
- Hardcode a list of admin users in the configuration
- Use simple logic: "If current user is admin, show all projects; otherwise, show only their projects"
- Run two separate Relay instances (one per user)

The recommendation includes a code example showing the filtering logic, lists pros (simple, robust, clear separation) and cons (requires two instances, can't switch users without restarting).

**Next Steps**: Outlines what happens after this plan gets approved - review with stakeholders, choose the final approach, create implementation checklist, plan testing, document the process, then actually build it.

**Feasibility Assessment**: The final verdict - rates this as "Highly Viable" with medium effort (2-4 hours), low risk, minimal breaking changes, and includes a rollback plan (just move projects back to the flat structure if something goes wrong).

## How It Works

**The Planning Methodology**: This document follows a structured problem-solving approach. It starts by clearly defining the problem (need to add a second user with isolated access), then systematically explores the solution space by asking critical questions about how the current system works. Next, it brainstorms four completely different architectural approaches, carefully analyzing the trade-offs of each like comparing different routes on a map. Finally, it synthesizes a recommendation that combines the best aspects of the options analyzed.

**The Recommended Solution Flow**: The chosen "Hybrid" approach works like this:

1. **Startup**: When someone starts Relay, they set an environment variable (a computer setting) that says "RELAY_USER=xfg6gb" or "RELAY_USER=a28m2t2xu8go4a0qgblz7xxze"
2. **Project Organization**: All projects are organized into subdirectories - `/opt/clawd/projects/xfg6gb/` for one user and `/opt/clawd/projects/a28m2t2xu8go4a0qgblz7xxze/` for the other
3. **When Loading Projects**: The system reads the environment variable to know which user is active, checks a hardcoded list to see if they're an admin
4. **Filtering Logic**: If the user is an admin, scan and show ALL project folders from both users; if they're a regular user, scan and show ONLY their own project folder
5. **Deployment**: This means running two separate instances of Relay - one for each user, possibly on different ports (like 7786 and 7787) or different computers

**The Isolation Mechanism**: Think of it like two separate workspaces in the same building. Each user runs their own copy of the Relay program with their own environment setting. The programs are identical, but one has a setting that says "I'm user A" and the other says "I'm user B." When each program scans for projects, it looks at its own setting and decides what to show. The admin user's program has special logic that says "ignore the normal rules and show everything."

**Why Multiple Approaches Were Explored**: The document doesn't just present one solution - it thoughtfully explores four different ways to solve the problem because each has different trade-offs. Option A is simple but requires multiple instances. Option B has a nice UI but no real security. Option C has the best security but is most complex. Option D requires least change but needs metadata maintenance. By laying out all options, stakeholders can make an informed decision based on their priorities (security vs. simplicity vs. ease of use).

## Important Things to Know

**This is Planning Only - Zero Implementation**: The document repeatedly emphasizes in multiple sections that this is purely a planning document with no code being written and no system changes being made. It's like an architect drawing blueprints before construction begins - all the thinking and designing happens first, implementation comes later only after approval.

**Shared Credentials, Separate Workspaces**: An unusual requirement is that both users share the same SSH keys (login credentials) but need separate workspaces. This is like two employees sharing the same building access card but having their own locked offices inside. The document identifies this as a potential security consideration that needs careful file permission management.

**The Recommended Solution Requires Two Relay Instances**: A significant architectural decision in the recommended approach is running two separate copies of the Relay program - one for each user. This means they would access different URLs (like `localhost:7786` and `localhost:7787`) or possibly run on different computers entirely. Users cannot easily switch between accounts in the same browser window - they'd need to stop one instance and start the other with different settings.

**Administrator Has Full Access**: The admin user (with the long 25-character username) can see and access both users' projects - their own and the second user's. The document explicitly asks "is this acceptable?" and answers "Yes, per requirements." This is like a building superintendent having a master key - it's by design, not a security flaw.

**Medium Effort, Low Risk Assessment**: The feasibility section estimates 2-4 hours for implementation and testing, which is considered "medium effort" - not trivial but not enormous. Risk is rated "low" because changes are localized (affect only a few specific files) and there's a clear rollback plan if something goes wrong (just move projects back to the original flat folder structure).

**Four Different Architectural Approaches Analyzed**: Rather than presenting a single solution, this document thoroughly explores four distinct approaches with honest pros and cons for each. This demonstrates rigorous thinking and gives decision-makers options to choose from based on their priorities. The recommended "Hybrid" approach is essentially Option A (environment variables) with clearly defined admin privileges.

**Edge Cases and Security Are Explicitly Addressed**: The document includes a dedicated section on edge cases and security considerations, showing mature thinking about potential vulnerabilities like URL manipulation, session hijacking, and project name collisions. This isn't just "happy path" thinking - it considers what could go wrong.

**Specific Files Identified for Modification**: Unlike vague plans that just say "modify the code," this document specifically identifies five files/areas that would need changes and explains what kind of changes each would require. This shows the author has actually looked at the codebase structure and thought through the implementation details even though this is still the planning phase.

**Rollback Plan Included**: The feasibility assessment includes a rollback plan - if the implementation goes wrong, you can restore the original flat `/opt/clawd/projects/` structure. This is smart project management - always have an "undo" plan before making significant changes.

**The User Story Format**: The document uses a professional "User Story" format: "As a [role], I want [goal], So that [benefit]." This is a standard technique in software development to clearly articulate who benefits, what they need, and why they need it. It keeps the focus on user value rather than just technical features.

**Next Steps Are Clearly Defined**: The document doesn't leave the team hanging after planning - it explicitly outlines six next steps that should happen after the plan is approved, from stakeholder review through actual implementation. This shows good project management by bridging the gap between planning and execution.