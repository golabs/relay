{"id": "explain-f1580f7e", "message": "Please explain this Markdown document file in simple, easy-to-understand terms for someone who may not have technical skills.\n\n**File:** docs/SECURITY_AND_ARCHITECTURE.md\n\n**Content:**\n```\n# Walter Mobile App \u2014 Security & Architecture Guide\n\n## Document Purpose\n\nThis document outlines the complete security architecture, authentication flow, and integration strategy for the **Walter Voice Mobile App**. It is designed so that a developer can configure and deploy the mobile app securely, with **zero secrets stored on the device**.\n\n---\n\n## 1. Security Principles\n\n| Principle | Implementation |\n|---|---|\n| **No secrets on device** | All API keys, database credentials, and Azure service keys remain server-side only |\n| **Token-based auth** | Mobile app receives short-lived JWT access tokens + refresh tokens |\n| **Microsoft SSO** | Authentication via Microsoft Entra ID (formerly Azure AD) \u2014 no passwords stored |\n| **Encrypted transport** | All communication over HTTPS/WSS (TLS 1.2+) |\n| **Session isolation** | Redis-backed sessions with per-user, per-device tracking |\n| **Company isolation** | Server middleware ensures users only access their broker company data |\n\n---\n\n## 2. Authentication Flow\n\n### 2.1 Microsoft SSO Login (MSAL)\n\nThe mobile app uses **Microsoft Authentication Library (MSAL)** for native SSO. The flow is:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Mobile App  \u2502     \u2502  Walter Backend   \u2502     \u2502  Microsoft      \u2502\n\u2502  (Capacitor) \u2502     \u2502  (Express/Node)   \u2502     \u2502  Entra ID       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502                      \u2502                         \u2502\n       \u2502  1. GET /api/auth/microsoft                    \u2502\n       \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\u2502                         \u2502\n       \u2502                      \u2502                         \u2502\n       \u2502  2. Redirect URL     \u2502                         \u2502\n       \u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                         \u2502\n       \u2502                      \u2502                         \u2502\n       \u2502  3. Open browser/webview to Microsoft login    \u2502\n       \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\u2502\n       \u2502                      \u2502                         \u2502\n       \u2502  4. User authenticates + consents              \u2502\n       \u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n       \u2502                      \u2502                         \u2502\n       \u2502  5. Auth code sent to callback                 \u2502\n       \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\u2502                         \u2502\n       \u2502                      \u2502  6. Exchange code       \u2502\n       \u2502                      \u2502  for tokens             \u2502\n       \u2502                      \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\u2502\n       \u2502                      \u2502                         \u2502\n       \u2502                      \u2502  7. ID token +          \u2502\n       \u2502                      \u2502  access token returned  \u2502\n       \u2502                      \u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n       \u2502                      \u2502                         \u2502\n       \u2502                      \u2502  8. Auto-provision      \u2502\n       \u2502                      \u2502  user in Walter DB      \u2502\n       \u2502                      \u2502                         \u2502\n       \u2502  9. Walter JWT       \u2502                         \u2502\n       \u2502  (access + refresh)  \u2502                         \u2502\n       \u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                         \u2502\n       \u2502                      \u2502                         \u2502\n       \u2502  10. Store tokens    \u2502                         \u2502\n       \u2502  in secure storage   \u2502                         \u2502\n       \u2502  (Keychain/Keystore) \u2502                         \u2502\n       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                         \u2502\n```\n\n### 2.2 Token Lifecycle\n\n| Token | Purpose | Lifetime | Storage |\n|---|---|---|---|\n| **Access Token** | API authentication (Bearer header) | 24 hours | Capacitor Secure Storage / iOS Keychain / Android Keystore |\n| **Refresh Token** | Obtain new access token without re-login | 7 days | Capacitor Secure Storage / iOS Keychain / Android Keystore |\n| **Microsoft ID Token** | Server-side only, never sent to client | N/A | Server memory (discarded after user provisioning) |\n\n### 2.3 Token Refresh Flow\n\n```\nMobile App                     Walter Backend\n    \u2502                               \u2502\n    \u2502  POST /api/auth/refresh       \u2502\n    \u2502  { refreshToken: \"...\" }      \u2502\n    \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\u2502\n    \u2502                               \u2502\n    \u2502                               \u2502  Verify JWT signature\n    \u2502                               \u2502  Check session in Redis\n    \u2502                               \u2502  Check user is active\n    \u2502                               \u2502\n    \u2502  { accessToken, refreshToken }\u2502\n    \u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502\n    \u2502                               \u2502\n    \u2502  Store new tokens securely    \u2502\n    \u2502                               \u2502\n```\n\n### 2.4 What the Mobile App Receives\n\nThe mobile app **only** receives:\n\n```json\n{\n  \"accessToken\": \"eyJhbGciOiJIUzI1NiIs...\",\n  \"refreshToken\": \"eyJhbGciOiJIUzI1NiIs...\",\n  \"user\": {\n    \"id\": \"uuid\",\n    \"email\": \"brett@company.com\",\n    \"firstName\": \"Brett\",\n    \"lastName\": \"K\",\n    \"role\": \"broker\",\n    \"companyId\": \"uuid\"\n  }\n}\n```\n\n**No API keys, no Azure credentials, no database URLs** \u2014 ever.\n\n---\n\n## 3. Voice Conversation Architecture\n\n### 3.1 WebSocket Connection (Development Mode)\n\nFor development and smaller deployments, the mobile app connects directly to the Walter backend via WebSocket:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Mobile App  \u2502  WSS://  \u2502  Walter Backend   \u2502  WSS://  \u2502  Azure OpenAI   \u2502\n\u2502  (audio)     \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\u2502  RealtimeVoice    \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\u2502  Realtime API   \u2502\n\u2502              \u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502  Proxy            \u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n**Connection URL:**\n```\nwss://{WALTER_BACKEND}/api/voice/ws?token={ACCESS_TOKEN}\n```\n\n**Security:**\n1. JWT token validated before WebSocket upgrade\n2. One active voice session per user enforced\n3. Sessions auto-expire after 30 minutes of inactivity\n4. All Azure credentials handled server-side in the proxy\n\n### 3.2 Azure Web PubSub (Production Mode)\n\nFor production scale, the app uses Azure Web PubSub as a message broker:\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Mobile App  \u2502  WSS://  \u2502  Azure Web       \u2502  Events  \u2502  Walter Backend  \u2502\n\u2502  (audio)     \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\u2502  PubSub          \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500>\u2502  RealtimeVoice   \u2502\n\u2502              \u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502  Service          \u2502<\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502  Proxy           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                                                \u2502  WSS://\n                                                       \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                                                       \u2502  Azure OpenAI  \u2502\n                                                       \u2502  Realtime API  \u2502\n                                                       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n**Connection Flow:**\n1. Mobile app calls `POST /api/voice/negotiate` with Bearer token\n2. Backend validates token, creates Web PubSub access token\n3. Mobile app receives temporary WebSocket URL (short-lived, scoped)\n4. App connects to Web PubSub \u2014 messages routed to backend automatically\n5. Backend proxies audio to/from Azure OpenAI Realtime API\n\n**Why Web PubSub for production:**\n- Auto-scaling to thousands of concurrent voice sessions\n- Geographic distribution for lower latency\n- Connection resilience with automatic reconnection\n- No direct WebSocket connection to backend required\n\n### 3.3 Audio Data Flow\n\n```\nUser speaks \u2192 Microphone \u2192 WebAudio API \u2192 PCM16 encoding\n    \u2192 WebSocket message \u2192 Backend proxy \u2192 Azure OpenAI Realtime\n    \u2192 AI response audio \u2192 Backend proxy \u2192 WebSocket\n    \u2192 PCM16 decoding \u2192 WebAudio API \u2192 Speaker \u2192 User hears Walter\n```\n\n**Audio format:** PCM16, 24kHz sample rate, mono channel\n\n---\n\n## 4. Mobile App Configuration\n\n### 4.1 Environment Configuration File\n\nThe mobile app requires **only one configuration file** with non-secret values:\n\n```typescript\n// src/config/environment.ts\n\nexport const config = {\n  // Walter backend URL (NOT a secret \u2014 this is a public endpoint)\n  API_BASE_URL: 'https://walter-api.yourcompany.com',\n\n  // Microsoft Entra ID \u2014 public client configuration\n  // These are NOT secrets \u2014 they are public app registration values\n  MSAL_CLIENT_ID: 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx',\n  MSAL_AUTHORITY: 'https://login.microsoftonline.com/YOUR_TENANT_ID',\n  MSAL_REDIRECT_URI: 'msauth.com.walter.voice://auth',\n  MSAL_SCOPES: ['openid', 'profile', 'email', 'User.Read'],\n\n  // App configuration\n  APP_VERSION: '1.0.0',\n  VOICE_SAMPLE_RATE: 24000,\n  VOICE_CHANNELS: 1,\n  SESSION_TIMEOUT_MS: 1800000, // 30 minutes\n};\n```\n\n> **Important:** The MSAL `CLIENT_ID` is a *public* identifier, not a secret. The mobile app uses the **public client** (PKCE) flow \u2014 no client secret is required on the device. The client secret exists only on the Walter backend server.\n\n### 4.2 What is NOT in the Mobile App\n\n| Secret | Where It Lives | Why |\n|---|---|---|\n| `AZURE_CLIENT_SECRET` | Walter backend `.env` only | OAuth2 server-side exchange |\n| `JWT_SECRET` | Walter backend `.env` only | Token signing/verification |\n| `AZURE_OPENAI_KEY` | Walter backend `.env` only | AI API access |\n| `AZURE_REALTIME_KEY` | Walter backend `.env` only | Voice API access |\n| `DATABASE_URL` | Walter backend `.env` only | Database connection |\n| `REDIS_URL` | Walter backend `.env` only | Session storage |\n| `WEBPUBSUB_CONNECTION_STRING` | Walter backend `.env` only | Voice infrastructure |\n| `SESSION_SECRET` | Walter backend `.env` only | Cookie encryption |\n| `CLAIMSAI_SERVICE_PASSWORD` | Walter backend `.env` only | External service auth |\n\n### 4.3 Secure Token Storage on Device\n\n```typescript\n// Using Capacitor Secure Storage plugin\nimport { SecureStoragePlugin } from 'capacitor-secure-storage-plugin';\n\n// Store tokens after login\nawait SecureStoragePlugin.set({\n  key: 'walter_access_token',\n  value: accessToken\n});\n\nawait SecureStoragePlugin.set({\n  key: 'walter_refresh_token',\n  value: refreshToken\n});\n\n// Retrieve tokens for API calls\nconst { value: token } = await SecureStoragePlugin.get({\n  key: 'walter_access_token'\n});\n```\n\n**Platform security:**\n- **iOS**: Tokens stored in iOS Keychain (hardware-encrypted, biometric-protected)\n- **Android**: Tokens stored in Android Keystore (hardware-backed encryption)\n- **Cleared on logout** \u2014 tokens are removed from secure storage and invalidated on the server (Redis session destroyed)\n\n---\n\n## 5. API Interaction Patterns\n\n### 5.1 Authenticated API Calls\n\nEvery API request from the mobile app includes the JWT access token:\n\n```typescript\nconst response = await fetch(`${config.API_BASE_URL}/api/quotes`, {\n  method: 'GET',\n  headers: {\n    'Authorization': `Bearer ${accessToken}`,\n    'Content-Type': 'application/json',\n  },\n});\n\n// Handle 401 \u2014 token expired\nif (response.status === 401) {\n  const newTokens = await refreshTokens();\n  // Retry with new access token\n}\n```\n\n### 5.2 Key API Endpoints Used by Mobile App\n\n| Endpoint | Method | Purpose |\n|---|---|---|\n| `/api/auth/microsoft` | GET | Initiate Microsoft SSO login |\n| `/api/auth/microsoft/callback` | GET | Handle SSO callback |\n| `/api/auth/refresh` | POST | Refresh expired access token |\n| `/api/auth/logout` | POST | Logout + destroy session |\n| `/api/voice/negotiate` | POST | Get WebSocket connection URL |\n| `/api/voice/ws` | WS | Direct WebSocket voice connection |\n| `/api/voice/session` | POST | Initialize voice session |\n| `/api/voice/session` | DELETE | Terminate voice session |\n| `/api/quotes` | GET | List quotes |\n| `/api/quotes/:id` | GET | Get quote details |\n| `/api/chat` | POST | Send chat message |\n\n### 5.3 Error Handling Strategy\n\n```typescript\n// Centralized API client with auto-refresh\nclass WalterAPIClient {\n  async request(endpoint: string, options: RequestInit) {\n    let response = await fetch(`${API_BASE_URL}${endpoint}`, {\n      ...options,\n      headers: {\n        'Authorization': `Bearer ${await this.getAccessToken()}`,\n        ...options.headers,\n      },\n    });\n\n    // Token expired \u2014 refresh and retry once\n    if (response.status === 401) {\n      await this.refreshAccessToken();\n      response = await fetch(`${API_BASE_URL}${endpoint}`, {\n        ...options,\n        headers: {\n          'Authorization': `Bearer ${await this.getAccessToken()}`,\n          ...options.headers,\n        },\n      });\n    }\n\n    // Still unauthorized \u2014 force re-login\n    if (response.status === 401) {\n      await this.logout();\n      this.navigateToLogin();\n    }\n\n    return response;\n  }\n}\n```\n\n---\n\n## 6. Production Deployment Checklist\n\n### 6.1 Backend Configuration Required\n\nBefore the mobile app can connect, the Walter backend needs these additions to its environment:\n\n```env\n# Mobile app OAuth redirect URI (add to Azure AD app registration)\nAZURE_MOBILE_REDIRECT_URI=msauth.com.walter.voice://auth\n\n# CORS \u2014 add mobile app origin\nALLOWED_ORIGINS=https://walter.yourcompany.com,capacitor://localhost,http://localhost\n\n# Ensure these are set for production\nNODE_ENV=production\nJWT_SECRET=<random-64-char-string>\n```\n\n### 6.2 Azure AD App Registration Updates\n\n1. **Add platform**: In Azure Portal \u2192 App Registration \u2192 Authentication\n   - Add **Mobile and desktop applications** platform\n   - Set redirect URI: `msauth.com.walter.voice://auth`\n   - Enable **Allow public client flows** (required for PKCE on mobile)\n\n2. **API permissions**: Ensure these are granted:\n   - `openid` (Sign in)\n   - `profile` (Read basic profile)\n   - `email` (Read email address)\n   - `User.Read` (Read user profile)\n\n3. **Token configuration** (optional but recommended):\n   - Add `email` optional claim to ID token\n   - Add `preferred_username` optional claim to ID token\n\n### 6.3 Security Hardening Checklist\n\n- [ ] HTTPS enforced on all backend endpoints\n- [ ] WSS (WebSocket Secure) enforced for voice connections\n- [ ] JWT_SECRET is 64+ characters of cryptographic randomness\n- [ ] ALLOWED_ORIGINS strictly configured (no wildcards in production)\n- [ ] Rate limiting enabled on `/api/auth/*` endpoints\n- [ ] Redis configured with authentication and TLS (`rediss://`)\n- [ ] PostgreSQL configured with SSL (`?sslmode=require`)\n- [ ] Azure API keys rotated on schedule (multi-key support is built in)\n- [ ] App Transport Security (ATS) enabled on iOS (default)\n- [ ] Network Security Config enforces TLS on Android\n- [ ] Certificate pinning considered for high-security deployments\n- [ ] Biometric authentication for app unlock (optional enhancement)\n- [ ] Session invalidation on device change or suspicious activity\n\n---\n\n## 7. Technology Stack\n\n### Mobile App\n\n| Component | Technology | Purpose |\n|---|---|---|\n| **Framework** | Capacitor + React/TypeScript | Cross-platform (iOS + Android) |\n| **Auth Library** | `@azure/msal-react-native` | Native Microsoft SSO with PKCE |\n| **Token Storage** | `capacitor-secure-storage-plugin` | iOS Keychain / Android Keystore |\n| **Voice Capture** | WebAudio API + AudioWorklet | Real-time audio processing |\n| **WebSocket** | Native WebSocket API | Voice streaming |\n| **UI Framework** | Tailwind CSS / Custom c\n```\n\nPlease provide:\n1. **What This File Does** - A simple one-paragraph summary\n2. **Key Components** - Break down the main parts/sections in plain language\n3. **How It Works** - Explain the flow or logic simply\n4. **Important Things to Know** - Any key details a non-technical person should understand\n\nUse simple analogies where helpful. Avoid jargon or explain technical terms when you must use them.\n\nIMPORTANT: Respond ONLY with the explanation. Do not use any tools, do not read any files, do not make any changes. Just explain the content provided above.", "model": "sonnet", "project": "explain-walter_mobile_app", "status": "completed", "images": [], "files": [], "created": 1771056222.9584458, "job_type": "explain", "activity": "Thinking...", "started_at": 1771056424.3614488}