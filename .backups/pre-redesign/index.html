<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Relay</title>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>{{CSS_PLACEHOLDER}}</style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>Chat Relay</h1>
            <div class="header-center">
                <button class="workflow-btn" id="btnReviewTask" onclick="runWorkflowCommand('reviewtask')" title="Takes your input text + images, creates TASK.md, then runs /reviewtask to structure it">
                    <span class="step-num">1</span> Review Task
                </button>
                <button class="workflow-btn" id="btnExplain" onclick="runWorkflowCommand('explain')" title="Analyze task and create plan">
                    <span class="step-num">2</span> Explain
                </button>
                <button class="workflow-btn" id="btnImplement" onclick="runWorkflowCommand('implement')" title="Execute the implementation">
                    <span class="step-num">3</span> Implement
                </button>
            </div>
            <div class="header-controls">
                <div class="health-indicator" id="healthIndicator" onclick="showHealthDetails()" title="Click for details">
                    <div class="health-dot checking" id="healthDot"></div>
                    <span class="health-text" id="healthText">Checking...</span>
                </div>
                <button class="icon-btn danger" id="resetBtn" onclick="openResetModal()" style="display:none;" title="Reset System">‚Üª</button>
                <select id="projectSelect" class="project-select">
                    <option value="">No Project</option>
                </select>
                <button class="icon-btn" onclick="openFileBrowser()" title="File Browser">üìÅ</button>
                <button class="icon-btn" onclick="openGitModal()" title="Git Operations">‚éá</button>
                <button class="icon-btn" onclick="openDisplaySettings()" title="Display Settings">‚ó´</button>
                <button class="icon-btn" onclick="openVoiceSettings()" title="Voice Settings">‚öô</button>
            </div>
        </div>

        <!-- Job acknowledgment banner -->
        <div id="ackBanner" class="ack-banner" style="display:none;">
            <span id="ackText">Message received - waiting for Claude...</span>
        </div>

        <!-- Message Queue Panel -->
        <div id="queuePanel" class="queue-panel">
            <div class="queue-header">
                <span class="queue-title">Message Queue (<span id="queueCount">0</span>)</span>
                <button class="btn" onclick="clearQueue()" style="padding:4px 8px;font-size:11px;">Clear All</button>
            </div>
            <div class="queue-list" id="queueList"></div>
        </div>

        <!-- Reset System Modal -->
        <div id="resetModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>System Controls</h3>
                    <button class="modal-close" onclick="closeResetModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="reset-option" onclick="resetAction('clear-queue')">
                        <div class="reset-option-title">Clear Message Queue</div>
                        <div class="reset-option-desc">Remove all pending messages from the queue</div>
                    </div>
                    <div class="reset-option" onclick="resetAction('restart-watcher')">
                        <div class="reset-option-title">Restart Watcher</div>
                        <div class="reset-option-desc">Stop and restart the job processor</div>
                    </div>
                    <div class="reset-option" onclick="resetAction('cancel-current')">
                        <div class="reset-option-title">Cancel Current Job</div>
                        <div class="reset-option-desc">Stop the currently processing job</div>
                    </div>
                    <div class="reset-option danger" onclick="resetAction('full-reset')">
                        <div class="reset-option-title">Full System Reset</div>
                        <div class="reset-option-desc">Clear queue, restart watcher, reset everything</div>
                    </div>
                    <div id="resetStatus" class="reset-status"></div>
                </div>
            </div>
        </div>

        <main class="main">
            <!-- History Sidebar -->
            <div class="history-sidebar" id="historySidebar">
                <div class="pane-header">
                    <div class="pane-title">History</div>
                    <div class="pane-controls">
                        <button class="btn" onclick="toggleHistorySidebar()" title="Collapse">&lsaquo;</button>
                    </div>
                </div>
                <div class="history-list" id="historyList">
                    <div style="color:var(--text-secondary);text-align:center;padding:20px;">Select a project to see history</div>
                </div>
                <div class="history-count" id="historyCount"></div>
                <button class="btn delete-selected-btn" id="deleteSelectedBtn" onclick="deleteSelectedHistory()">Delete Selected (<span id="selectedCount">0</span>)</button>
                <button class="btn" onclick="clearHistory()" style="width:100%;margin-top:8px;background:var(--error);color:white;" title="Clear all history">Clear All History</button>
            </div>

            <!-- AXION Panel - Responses -->
            <div class="pane response-pane" id="axionPane" ondblclick="toggleFullscreen()">
                <div class="pane-header">
                    <div class="pane-title">
                        <button class="icon-btn" id="sidebarToggle" onclick="toggleHistorySidebar()" style="display:none;" title="Toggle History">üìö</button>
                        <span>AXION</span>
                        <span class="fullscreen-hint">(double-click to exit)</span>
                    </div>
                    <div class="pane-controls">
                        <button class="icon-btn danger" id="pauseBtn" onclick="togglePause()" style="display:none;" title="Pause to add more info">‚è∏</button>
                        <button class="icon-btn" id="autoReadBtn" onclick="toggleAutoRead()" title="Auto-read responses">üîá</button>
                        <button class="icon-btn" onclick="readResponse()" title="Read aloud">üîä</button>
                        <button class="icon-btn" onclick="showScreenshotGallery()" title="Screenshots">üñº</button>
                        <button class="icon-btn" onclick="clearResponse()" title="Clear">üóë</button>
                    </div>
                </div>
                <div class="pane-content" id="axionPaneContent">
                    <!-- Live Activity Box - pinned at top, always visible -->
                    <div class="live-activity-box" id="liveActivityBox">
                        <div class="live-activity-header">
                            <span class="live-indicator">‚óè LIVE</span>
                            <span class="live-status" id="liveStatus">Waiting...</span>
                        </div>
                        <div class="live-activity-content" id="liveActivityContent"></div>
                        <div class="live-voice-visualizer" id="liveVoiceVisualizer">
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                        </div>
                    </div>
                    <!-- History area - completed content (chronological, oldest first) -->
                    <div class="response-area" id="responseArea"></div>
                </div>
                <!-- Scroll to Bottom button - positioned relative to AXION pane -->
                <button class="scroll-to-bottom-btn" id="scrollToBottomBtn" onclick="scrollAxionToBottom()" title="Scroll to bottom">&#8595; Bottom</button>
            </div>

            <!-- BRETT Panel - Input -->
            <div class="pane input-pane" id="brettPane" ondblclick="toggleBrettFullscreen(event)">
                <div class="pane-header">
                    <div class="pane-title">
                        <span>BRETT</span>
                        <span class="fullscreen-hint">(double-click to exit)</span>
                        <div class="voice-dots" id="voiceDots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                    <div class="pane-controls">
                        <button class="icon-btn" id="copyInputBtn" onclick="copyInputText()" title="Copy text">üìã</button>
                        <button class="icon-btn" onclick="clearInput()" title="Clear text">üóë</button>
                        <button class="icon-btn" id="voiceBtn" onclick="toggleVoice()" title="Voice input">üé§</button>
                        <button class="icon-btn" onclick="readInput()" title="Read aloud">üîä</button>
                        <button class="icon-btn" id="formatBtn" onclick="formatInput()" title="Format text">‚ú®</button>
                        <button class="icon-btn" onclick="startMockup()" title="Design Mockup">üé®</button>
                        <button class="icon-btn primary" onclick="sendMessage()" title="Send message">‚ñ∂</button>
                    </div>
                </div>
                <div class="pane-content">
                    <div class="input-wrapper">
                        <div class="line-numbers" id="lineNumbers">1</div>
                        <textarea class="input-area" id="inputArea" placeholder="Type your message... (Ctrl+Enter to send, Shift+Enter for newline)"></textarea>
                    </div>
                </div>
                <div id="imageContainer" class="image-preview-container" style="display:none;"></div>
            </div>
        </main>

        <!-- Questions Modal -->
        <div id="questionsModal" class="modal-overlay">
            <div class="modal-content" style="max-width:650px;">
                <div class="modal-header">
                    <h3>Claude needs your input</h3>
                    <button class="modal-close" onclick="skipQuestions()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="questionsPreview" style="background:var(--bg);padding:12px;border-radius:6px;margin-bottom:16px;max-height:200px;overflow-y:auto;font-size:13px;color:var(--text-secondary);"></div>
                    <div id="questionsForm"></div>

                    <!-- Additional Context Section -->
                    <div class="questions-context-section" style="margin-top:16px; border-top:1px solid var(--border); padding-top:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <label style="color:var(--text-secondary); font-size:13px;">Additional context or details (optional):</label>
                            <button class="icon-btn" id="questionsVoiceBtn" onclick="toggleQuestionsVoice()" title="Voice input" style="font-size:16px;">üé§</button>
                        </div>
                        <textarea id="questionsContextInput" placeholder="Add any extra information, clarifications, or context you want Claude to know..." style="width:100%; min-height:80px; padding:10px; background:var(--bg-input); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:14px; resize:vertical;"></textarea>
                        <div id="questionsVoiceIndicator" style="display:none; color:var(--accent); font-size:12px; margin-top:4px;">üî¥ Listening... speak now</div>
                    </div>

                    <div style="display:flex;gap:8px;margin-top:16px;">
                        <button class="btn success" onclick="submitAnswers()">Send Answers</button>
                        <button class="btn" onclick="skipQuestions()">Skip</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Display Settings Modal -->
        <div id="displayModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; padding:40px;">
            <div style="background:var(--bg-pane); border:1px solid var(--border); border-radius:8px; max-width:500px; margin:0 auto;">
                <div style="padding:16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">Display Settings</h3>
                    <button onclick="closeDisplaySettings()" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer;">&times;</button>
                </div>
                <div style="padding:16px;">
                    <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">AXION Font Size: <span id="axionSizeLabel">14px</span></label>
                    <input type="range" id="axionFontSize" min="10" max="24" value="14" style="width:100%; margin-bottom:16px;" oninput="previewAxionFont(this.value)">

                    <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">BRETT Font Size: <span id="brettSizeLabel">14px</span></label>
                    <input type="range" id="brettFontSize" min="10" max="24" value="14" style="width:100%; margin-bottom:16px;" oninput="previewBrettFont(this.value)">

                    <div style="border-top:1px solid var(--border); margin:16px 0; padding-top:16px;">
                        <h4 style="margin:0 0 12px 0; color:var(--accent);">File Browser Settings</h4>

                        <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">Code Editor Font Size: <span id="editorSizeLabel">14px</span></label>
                        <input type="range" id="editorFontSize" min="10" max="24" value="14" style="width:100%; margin-bottom:16px;" oninput="previewEditorFont(this.value)">

                        <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">Explain Panel Font Size: <span id="explainSizeLabel">14px</span></label>
                        <input type="range" id="explainFontSize" min="10" max="24" value="14" style="width:100%; margin-bottom:16px;" oninput="previewExplainFont(this.value)">

                        <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">File Tree Font Size: <span id="fileTreeSizeLabel">13px</span></label>
                        <input type="range" id="fileTreeFontSize" min="10" max="20" value="13" style="width:100%; margin-bottom:16px;" oninput="previewFileTreeFont(this.value)">
                    </div>

                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn primary" onclick="saveDisplaySettings()">Save</button>
                        <button class="btn" onclick="resetDisplaySettings()">Reset to Default</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voice Settings Modal -->
        <div id="voiceModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; padding:20px; overflow-y:auto;">
            <div style="background:var(--bg-pane); border:1px solid var(--border); border-radius:8px; max-width:700px; margin:0 auto;">
                <div style="padding:16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">Voice Settings</h3>
                    <button onclick="closeVoiceSettings()" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer;">&times;</button>
                </div>
                <div style="padding:16px;">
                    <!-- Voice Engine Selection -->
                    <div style="margin-bottom:20px; padding:12px; background:var(--bg); border-radius:6px; border:1px solid var(--border);">
                        <label style="display:block; margin-bottom:8px; color:var(--accent); font-weight:600;">Voice Engine:</label>
                        <div style="display:flex; gap:8px;">
                            <button id="engineBrowser" class="btn" onclick="setVoiceEngine('browser')" style="flex:1; padding:10px;">Browser (Built-in)</button>
                            <button id="engineEdgeTTS" class="btn" onclick="setVoiceEngine('edge-tts')" style="flex:1; padding:10px;">Edge TTS (Neural)</button>
                            <button id="engineElevenLabs" class="btn" onclick="setVoiceEngine('elevenlabs')" style="flex:1; padding:10px;">ElevenLabs (Premium)</button>
                        </div>
                        <p id="engineDescription" style="font-size:11px; color:var(--text-secondary); margin:8px 0 0 0;">Browser voices are instant. Edge TTS uses Microsoft neural voices for higher quality.</p>
                    </div>

                    <!-- Edge TTS Voice Selection (shown when Edge TTS engine is selected) -->
                    <div id="edgeTtsSection" style="display:none; margin-bottom:20px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">AXION Edge Voice:</label>
                                <select id="axionEdgeVoice" style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border); color:var(--text); border-radius:4px;">
                                    <option value="">Loading voices...</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">BRETT Edge Voice:</label>
                                <select id="brettEdgeVoice" style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border); color:var(--text); border-radius:4px;">
                                    <option value="">Loading voices...</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:8px; display:flex; gap:8px;">
                            <button class="btn" onclick="testEdgeVoice('axion')">Test AXION Edge</button>
                            <button class="btn" onclick="testEdgeVoice('brett')">Test BRETT Edge</button>
                        </div>
                    </div>

                    <!-- ElevenLabs Voice Selection (shown when ElevenLabs engine is selected) -->
                    <div id="elevenLabsSection" style="display:none; margin-bottom:20px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">AXION ElevenLabs Voice:</label>
                                <select id="axionElevenVoice" style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border); color:var(--text); border-radius:4px;">
                                    <option value="">Loading voices...</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">BRETT ElevenLabs Voice:</label>
                                <select id="brettElevenVoice" style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border); color:var(--text); border-radius:4px;">
                                    <option value="">Loading voices...</option>
                                </select>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px;">
                            <div>
                                <label style="display:block; margin-bottom:4px; color:var(--text-secondary); font-size:12px;">Stability: <span id="elevenStabilityVal">0.5</span></label>
                                <input type="range" id="elevenStability" min="0" max="1" step="0.05" value="0.5" style="width:100%;" oninput="document.getElementById('elevenStabilityVal').textContent=this.value">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:4px; color:var(--text-secondary); font-size:12px;">Similarity: <span id="elevenSimilarityVal">0.75</span></label>
                                <input type="range" id="elevenSimilarity" min="0" max="1" step="0.05" value="0.75" style="width:100%;" oninput="document.getElementById('elevenSimilarityVal').textContent=this.value">
                            </div>
                        </div>
                        <div style="margin-top:8px; display:flex; gap:8px;">
                            <button class="btn" onclick="testElevenLabsVoice('axion')">Test AXION</button>
                            <button class="btn" onclick="testElevenLabsVoice('brett')">Test BRETT</button>
                        </div>
                        <!-- Voice Personality - auto-sets chat personality to match voice character -->
                        <div style="margin-top:12px; padding:10px; background:var(--bg); border-radius:6px; border:1px solid var(--border);">
                            <label style="display:block; margin-bottom:6px; color:var(--accent); font-weight:600; font-size:13px;">Voice Personality:</label>
                            <select id="elevenPersonality" onchange="setElevenPersonality(this.value)" style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border); color:var(--text); border-radius:4px;">
                                <option value="neutral">Neutral (Standard)</option>
                                <option value="tars">TARS - Witty &amp; Sarcastic (Interstellar)</option>
                                <option value="cheerful">Cheerful - Upbeat &amp; Enthusiastic</option>
                                <option value="business">Business - Professional &amp; Concise</option>
                                <option value="grumpy">Grumpy - Reluctant but Helpful</option>
                                <option value="zen">Zen - Calm &amp; Philosophical</option>
                                <option value="pirate">Pirate - Arr, Sailing the Seas!</option>
                                <option value="hal">HAL 9000 - Calm &amp; Unsettling (2001)</option>
                            </select>
                            <p style="font-size:11px; color:var(--text-secondary); margin:6px 0 0 0;">Sets the AI personality for chat responses. Pairs with the selected voice for full character immersion.</p>
                            <div style="margin-top:10px;">
                                <label style="display:block; margin-bottom:4px; color:var(--text-secondary); font-size:12px;">Custom Personality Prompt: <span style="color:var(--accent); cursor:pointer; font-size:11px;" onclick="resetPersonalityPrompt()">[Reset to Default]</span></label>
                                <textarea id="customPersonalityPrompt" rows="4" style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border); color:var(--text); border-radius:4px; font-size:12px; font-family:inherit; resize:vertical;" placeholder="Edit the system prompt that controls how the AI responds..."></textarea>
                                <p style="font-size:11px; color:var(--text-secondary); margin:4px 0 0 0;">This is the system prompt sent with every message. Edit it to change how the AI responds.</p>
                            </div>
                        </div>
                        <p style="font-size:11px; color:var(--text-secondary); margin:8px 0 0 0;">ElevenLabs uses your API credits. Lower stability = more expressive. Higher similarity = closer to original voice.</p>
                    </div>

                    <!-- Browser Voice Selection (shown when Browser engine is selected) -->
                    <div id="browserVoiceSection" style="margin-bottom:20px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">AXION Voice:</label>
                                <select id="axionVoice" style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border); color:var(--text); border-radius:4px;"></select>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">BRETT Voice:</label>
                                <select id="brettVoice" style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border); color:var(--text); border-radius:4px;"></select>
                            </div>
                        </div>
                        <!-- Voice Tuning - Pitch & Rate (browser only) -->
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">AXION Pitch: <span id="axionPitchVal">1.0</span></label>
                                <input type="range" id="axionPitch" min="0.5" max="1.5" step="0.1" value="1.0" style="width:100%;" oninput="document.getElementById('axionPitchVal').textContent=this.value">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">AXION Rate: <span id="axionRateVal">1.0</span></label>
                                <input type="range" id="axionRate" min="0.5" max="1.5" step="0.1" value="1.0" style="width:100%;" oninput="document.getElementById('axionRateVal').textContent=this.value">
                            </div>
                        </div>
                        <!-- Voice Presets (browser only) -->
                        <div style="margin-bottom:20px;">
                            <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">Voice Presets:</label>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn" onclick="applyVoicePreset('default')">Default</button>
                                <button class="btn" onclick="applyVoicePreset('hal')">HAL 9000</button>
                                <button class="btn" onclick="applyVoicePreset('calm')">Calm</button>
                                <button class="btn" onclick="applyVoicePreset('fast')">Fast</button>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <button class="btn" onclick="testVoice('axion')">Test AXION</button>
                            <button class="btn" onclick="testVoice('brett')">Test BRETT</button>
                        </div>
                    </div>

                    <!-- Save button (always visible) -->
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:24px;">
                        <button class="btn primary" onclick="saveVoiceSettings()">Save</button>
                    </div>

                    <!-- Voice Commands Reference -->
                    <div style="border-top:1px solid var(--border); padding-top:16px;">
                        <h4 style="margin:0 0 12px 0; color:var(--accent);">üìã Voice Commands Reference</h4>
                        <div style="max-height:200px; overflow-y:auto; background:var(--bg); border-radius:6px; padding:12px;">
                            <table style="width:100%; font-size:13px; border-collapse:collapse;">
                                <thead>
                                    <tr style="color:var(--text-secondary); text-align:left;">
                                        <th style="padding:4px 8px; border-bottom:1px solid var(--border);">Command</th>
                                        <th style="padding:4px 8px; border-bottom:1px solid var(--border);">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="voiceCommandsTable">
                                    <tr><td style="padding:4px 8px;">run send</td><td style="padding:4px 8px; color:var(--text-secondary);">Send message</td></tr>
                                    <tr><td style="padding:4px 8px;">run clear</td><td style="padding:4px 8px; color:var(--text-secondary);">Clear Brett input</td></tr>
                                    <tr><td style="padding:4px 8px;">run format</td><td style="padding:4px 8px; color:var(--text-secondary);">Format text</td></tr>
                                    <tr><td style="padding:4px 8px;">run read</td><td style="padding:4px 8px; color:var(--text-secondary);">Read Brett aloud</td></tr>
                                    <tr><td style="padding:4px 8px;">run stop</td><td style="padding:4px 8px; color:var(--text-secondary);">Stop current job</td></tr>
                                    <tr><td style="padding:4px 8px;">run refresh</td><td style="padding:4px 8px; color:var(--text-secondary);">Refresh page</td></tr>
                                    <tr><td style="padding:4px 8px;">run fullscreen</td><td style="padding:4px 8px; color:var(--text-secondary);">Enter fullscreen</td></tr>
                                    <tr><td style="padding:4px 8px;">run commit</td><td style="padding:4px 8px; color:var(--text-secondary);">Open Git modal</td></tr>
                                    <tr><td style="padding:4px 8px;">run review task</td><td style="padding:4px 8px; color:var(--text-secondary);">Run /reviewtask</td></tr>
                                    <tr><td style="padding:4px 8px;">run explain</td><td style="padding:4px 8px; color:var(--text-secondary);">Run /explain</td></tr>
                                    <tr><td style="padding:4px 8px;">run implement</td><td style="padding:4px 8px; color:var(--text-secondary);">Run /implement</td></tr>
                                    <tr><td style="padding:4px 8px;">run [project]</td><td style="padding:4px 8px; color:var(--text-secondary);">Open project in new tab</td></tr>
                                    <tr><td style="padding:4px 8px;">axion clear</td><td style="padding:4px 8px; color:var(--text-secondary);">Clear Axion display</td></tr>
                                    <tr><td style="padding:4px 8px;">axion read</td><td style="padding:4px 8px; color:var(--text-secondary);">Read Axion aloud (pauses Brett voice)</td></tr>
                                    <tr><td style="padding:4px 8px;">axion read stop</td><td style="padding:4px 8px; color:var(--text-secondary);">Stop Axion reading</td></tr>
                                    <tr><td style="padding:4px 8px;">axion screenshots</td><td style="padding:4px 8px; color:var(--text-secondary);">Open screenshots</td></tr>
                                    <tr><td style="padding:4px 8px;">open [project]</td><td style="padding:4px 8px; color:var(--text-secondary);">Switch project</td></tr>
                                    <tr><td style="padding:4px 8px;">stop read</td><td style="padding:4px 8px; color:var(--text-secondary);">Stop any reading</td></tr>
                                    <tr><td style="padding:4px 8px;">stop voice</td><td style="padding:4px 8px; color:var(--text-secondary);">Commands only mode</td></tr>
                                    <tr><td style="padding:4px 8px;">start voice</td><td style="padding:4px 8px; color:var(--text-secondary);">Full dictation mode</td></tr>
                                    <tr><td style="padding:4px 8px;">run voice</td><td style="padding:4px 8px; color:var(--text-secondary);">Full dictation mode</td></tr>
                                    <tr><td style="padding:4px 8px;">stop fullscreen</td><td style="padding:4px 8px; color:var(--text-secondary);">Exit fullscreen</td></tr>
                                    <tr><td colspan="2" style="padding:8px 8px 4px 8px; color:var(--accent); font-weight:bold; border-top:1px solid var(--border);">Text Editing</td></tr>
                                    <tr><td style="padding:4px 8px;">delete last word</td><td style="padding:4px 8px; color:var(--text-secondary);">Remove last word</td></tr>
                                    <tr><td style="padding:4px 8px;">delete all</td><td style="padding:4px 8px; color:var(--text-secondary);">Clear all text</td></tr>
                                    <tr><td style="padding:4px 8px;">delete last sentence</td><td style="padding:4px 8px; color:var(--text-secondary);">Remove last sentence</td></tr>
                                    <tr><td style="padding:4px 8px;">undo</td><td style="padding:4px 8px; color:var(--text-secondary);">Undo last change</td></tr>
                                    <tr><td style="padding:4px 8px;">new line</td><td style="padding:4px 8px; color:var(--text-secondary);">Insert line break</td></tr>
                                    <tr><td style="padding:4px 8px;">new paragraph</td><td style="padding:4px 8px; color:var(--text-secondary);">Insert two line breaks</td></tr>
                                    <tr><td style="padding:4px 8px;">go to line [N]</td><td style="padding:4px 8px; color:var(--text-secondary);">Move cursor to line N</td></tr>
                                    <tr><td colspan="2" style="padding:8px 8px 4px 8px; color:var(--accent); font-weight:bold; border-top:1px solid var(--border);">Lists</td></tr>
                                    <tr><td style="padding:4px 8px;">bullet point</td><td style="padding:4px 8px; color:var(--text-secondary);">Start bullet list mode</td></tr>
                                    <tr><td style="padding:4px 8px;">stop bullet</td><td style="padding:4px 8px; color:var(--text-secondary);">Exit bullet list mode</td></tr>
                                    <tr><td style="padding:4px 8px;">numbered list</td><td style="padding:4px 8px; color:var(--text-secondary);">Start numbered list mode</td></tr>
                                    <tr><td style="padding:4px 8px;">stop numbered</td><td style="padding:4px 8px; color:var(--text-secondary);">Exit numbered list mode</td></tr>
                                    <tr><td colspan="2" style="padding:8px 8px 4px 8px; color:var(--accent); font-weight:bold; border-top:1px solid var(--border);">File Browser</td></tr>
                                    <tr><td style="padding:4px 8px;">open editor</td><td style="padding:4px 8px; color:var(--text-secondary);">Open file browser</td></tr>
                                    <tr><td style="padding:4px 8px;">close editor</td><td style="padding:4px 8px; color:var(--text-secondary);">Close file browser</td></tr>
                                    <tr><td style="padding:4px 8px;">save file</td><td style="padding:4px 8px; color:var(--text-secondary);">Save current file</td></tr>
                                    <tr><td style="padding:4px 8px;">read file</td><td style="padding:4px 8px; color:var(--text-secondary);">Read file aloud</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Custom Aliases -->
                    <div style="border-top:1px solid var(--border); padding-top:16px; margin-top:16px;">
                        <h4 style="margin:0 0 12px 0; color:var(--accent);">üéØ Custom Voice Aliases</h4>
                        <p style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">Add alternate phrases that trigger the same command (e.g., "run sen" ‚Üí "run send")</p>
                        <div style="display:flex; gap:8px; margin-bottom:12px;">
                            <input type="text" id="aliasPhrase" placeholder="Spoken phrase (e.g., run sen)" style="flex:1; padding:8px; background:var(--bg-input); border:1px solid var(--border); color:var(--text); border-radius:4px;">
                            <select id="aliasCommand" style="flex:1; padding:8px; background:var(--bg-input); border:1px solid var(--border); color:var(--text); border-radius:4px;">
                                <option value="">Select command...</option>
                                <optgroup label="Actions">
                                    <option value="run send">run send</option>
                                    <option value="run clear">run clear</option>
                                    <option value="run format">run format</option>
                                    <option value="run read">run read</option>
                                    <option value="run stop">run stop</option>
                                    <option value="run refresh">run refresh</option>
                                    <option value="run fullscreen">run fullscreen</option>
                                    <option value="run commit">run commit</option>
                                    <option value="run review task">run review task</option>
                                    <option value="run explain">run explain</option>
                                    <option value="run implement">run implement</option>
                                </optgroup>
                                <optgroup label="Axion">
                                    <option value="axion clear">axion clear</option>
                                    <option value="axion read">axion read</option>
                                    <option value="axion read stop">axion read stop</option>
                                    <option value="axion screenshots">axion screenshots</option>
                                </optgroup>
                                <optgroup label="Control">
                                    <option value="stop read">stop read</option>
                                    <option value="stop voice">stop voice</option>
                                    <option value="start voice">start voice</option>
                                    <option value="run voice">run voice</option>
                                    <option value="stop fullscreen">stop fullscreen</option>
                                </optgroup>
                                <optgroup label="Text Editing">
                                    <option value="delete last word">delete last word</option>
                                    <option value="delete all">delete all</option>
                                    <option value="delete last sentence">delete last sentence</option>
                                    <option value="undo">undo</option>
                                    <option value="new line">new line</option>
                                    <option value="new paragraph">new paragraph</option>
                                </optgroup>
                                <optgroup label="Lists">
                                    <option value="bullet point">bullet point</option>
                                    <option value="stop bullet">stop bullet</option>
                                    <option value="numbered list">numbered list</option>
                                    <option value="stop numbered">stop numbered</option>
                                </optgroup>
                                <optgroup label="File Browser">
                                    <option value="open editor">open editor</option>
                                    <option value="close editor">close editor</option>
                                    <option value="save file">save file</option>
                                    <option value="read file">read file</option>
                                </optgroup>
                            </select>
                            <button class="btn primary" onclick="addVoiceAlias()" style="padding:8px 16px;">Add</button>
                        </div>
                        <div id="aliasesList" style="background:var(--bg); border-radius:6px; padding:8px; min-height:40px;">
                            <span style="color:var(--text-secondary); font-size:12px;">No custom aliases yet</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Git Modal -->
        <div id="gitModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; padding:40px;">
            <div style="background:var(--bg-pane); border:1px solid var(--border); border-radius:8px; max-width:600px; margin:0 auto; max-height:90vh; display:flex; flex-direction:column;">
                <div style="padding:16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">Git Operations</h3>
                    <button onclick="closeGitModal()" style="background:none; border:none; color:var(--text); font-size:20px; cursor:pointer;">&times;</button>
                </div>
                <div style="padding:16px; flex:1; overflow-y:auto;">
                    <div style="margin-bottom:16px;">
                        <label style="display:block; margin-bottom:8px; color:var(--text-secondary);">Project:</label>
                        <span id="gitProject" style="color:var(--accent); font-weight:bold;">-</span>
                    </div>

                    <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                        <button class="btn" onclick="gitStatus()" id="gitStatusBtn">Status</button>
                        <button class="btn primary" onclick="gitCommit()" id="gitCommitBtn">Commit & Push</button>
                    </div>

                    <div style="margin-bottom:8px; color:var(--text-secondary);">Output:</div>
                    <pre id="gitOutput" style="background:var(--bg); border:1px solid var(--border); border-radius:4px; padding:12px; margin:0; white-space:pre-wrap; word-wrap:break-word; font-size:12px; max-height:300px; overflow-y:auto; color:var(--text);">Ready for Git commands...</pre>
                </div>
            </div>
        </div>

        <!-- File Browser Modal -->
        <div id="fileBrowserModal" class="modal-overlay" style="display:none;">
            <div class="file-browser-container">
                <div class="file-browser-header">
                    <h3>File Browser - <span id="fileBrowserProject">-</span></h3>
                    <div class="file-browser-controls">
                        <button class="icon-btn" onclick="refreshFileTree()" title="Refresh">‚Üª</button>
                        <button class="icon-btn" onclick="closeFileBrowser()" title="Close">&times;</button>
                    </div>
                </div>
                <div class="file-browser-body">
                    <!-- File Tree Panel -->
                    <div class="file-tree-panel">
                        <div class="file-tree-search">
                            <input type="text" id="fileTreeFilter" placeholder="Filter files..." oninput="filterFileTree(this.value)">
                        </div>
                        <div id="fileTreeContainer" class="file-tree-container">
                            <div class="file-tree-loading">Select a project to browse files</div>
                        </div>
                    </div>
                    <!-- Editor Panel -->
                    <div class="editor-panel" id="editorPanel">
                        <div class="editor-header" ondblclick="toggleEditorFullscreen(event)">
                            <span id="editorFilePath" class="editor-file-path">No file open</span>
                            <div class="editor-controls">
                                <span id="editorStatus" class="editor-status"></span>
                                <button class="icon-btn" onclick="undoEdit()" title="Undo (Ctrl+Z)">‚Ü∂</button>
                                <button class="icon-btn" onclick="redoEdit()" title="Redo (Ctrl+Y)">‚Ü∑</button>
                                <button class="icon-btn" onclick="readFileAloud()" title="Read aloud">üîä</button>
                                <button class="icon-btn" onclick="toggleExplainPanel()" title="Explain file" id="explainBtn">üí°</button>
                                <button class="icon-btn primary" onclick="saveFile()" title="Save (Ctrl+S)">üíæ</button>
                                <button class="icon-btn" onclick="toggleEditorFullscreen()" title="Fullscreen" id="editorFullscreenBtn">‚õ∂</button>
                            </div>
                        </div>
                        <div class="editor-content-wrapper">
                            <div id="editorLineNumbers" class="editor-line-numbers">1</div>
                            <div class="editor-highlight-container">
                                <pre id="editorHighlight" class="editor-highlight"><code id="editorHighlightCode"></code></pre>
                                <textarea id="editorTextarea" class="editor-textarea" spellcheck="false" placeholder="Select a file to edit..."></textarea>
                            </div>
                        </div>
                        <!-- Modification now handled via Q&A panel in Explain -->
                    </div>
                    <!-- Explain Panel -->
                    <div class="explain-panel" id="explainPanel" style="display:none;">
                        <div class="explain-header" ondblclick="toggleExplainFullscreen(event)">
                            <span class="explain-title">üí° File Explanation</span>
                            <span id="explainStatus" class="explain-status"></span>
                            <span id="explainTimestamp" class="explain-timestamp"></span>
                            <div class="explain-controls">
                                <button class="icon-btn" onclick="readExplanationAloud()" title="Read explanation aloud">üîä</button>
                                <button class="icon-btn" onclick="toggleQaPanel()" title="Ask questions about this file">üí¨</button>
                                <button class="icon-btn" onclick="refreshExplanation()" title="Refresh explanation">üîÑ</button>
                                <button class="icon-btn" onclick="toggleExplainFullscreen()" title="Fullscreen" id="explainFullscreenBtn">‚õ∂</button>
                                <button class="icon-btn" onclick="toggleExplainPanel()" title="Close">‚úï</button>
                            </div>
                        </div>
                        <div class="explain-content" id="explainContent">
                            <div class="explain-placeholder">Open a file to see its explanation</div>
                        </div>
                        <!-- Q&A Panel -->
                        <div class="qa-panel" id="qaPanel" style="display:none;">
                            <div class="qa-header">
                                <span class="qa-title">üí¨ Ask About This File</span>
                                <div class="qa-controls">
                                    <button class="icon-btn active" id="qaAutoReadBtn" onclick="toggleQaAutoRead()" title="AI voice response: ON" style="background:var(--success);border-color:var(--success);">üéß</button>
                                    <button class="icon-btn" id="qaVoiceBtn" onclick="toggleQaVoice()" title="Voice input">üé§</button>
                                    <button class="icon-btn" onclick="clearQaHistory()" title="Clear history">üóëÔ∏è</button>
                                    <button class="icon-btn" onclick="toggleQaPanel()" title="Close Q&A">‚úï</button>
                                </div>
                            </div>
                            <div class="qa-history" id="qaHistory">
                                <div class="qa-message assistant">Ask any question about this file. I'll help you understand it better!</div>
                            </div>
                            <div class="qa-input-area">
                                <input type="text" id="qaInput" placeholder="Ask a question about this file..." onkeydown="handleQaKeydown(event)">
                                <button class="icon-btn primary" onclick="submitQaQuestion()" title="Send">‚ñ∂</button>
                            </div>
                        </div>
                    </div>
                    <!-- Diff Modal -->
                    <div id="diffModal" class="diff-modal" style="display:none;">
                        <div class="diff-header">
                            <h3>üìù Proposed Changes</h3>
                            <div class="diff-stats">
                                <span class="diff-added">+<span id="diffAddedCount">0</span> lines</span>
                                <span class="diff-removed">-<span id="diffRemovedCount">0</span> lines</span>
                            </div>
                            <div class="diff-controls">
                                <button class="icon-btn" onclick="readDiffAloud()" title="Read changes aloud">üîä</button>
                                <button class="icon-btn" onclick="closeDiffModal()" title="Close">‚úï</button>
                            </div>
                        </div>
                        <div class="diff-explanation" id="diffExplanation">
                            Changes will be explained here...
                        </div>
                        <div class="diff-container">
                            <div class="diff-pane">
                                <div class="diff-pane-header">Original</div>
                                <div class="diff-content" id="diffOriginal"></div>
                            </div>
                            <div class="diff-pane">
                                <div class="diff-pane-header">Proposed</div>
                                <div class="diff-content" id="diffProposed"></div>
                            </div>
                        </div>
                        <div class="diff-actions">
                            <button class="btn danger" onclick="revertChanges()">‚úï Revert</button>
                            <button class="btn success" onclick="acceptChanges()">‚úì Accept Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Keyboard shortcuts hint -->
        <div id="shortcutsHint" class="shortcuts-hint">
            <kbd>Ctrl</kbd>+<kbd>Enter</kbd> Send | <kbd>Esc</kbd> Close | <kbd>Ctrl</kbd>+<kbd>/</kbd> Sidebar
        </div>

        <!-- Image Lightbox with navigation -->
        <div id="imageLightbox" class="image-lightbox" onclick="closeLightbox()">
            <button class="lightbox-close" onclick="closeLightbox()" title="Close (Esc)">&times;</button>
            <button id="lightboxPrev" class="lightbox-nav lightbox-prev" onclick="event.stopPropagation(); navigateLightbox(-1)" title="Previous (‚Üê)">&#10094;</button>
            <img id="lightboxImage" src="" alt="Full size image" onclick="event.stopPropagation()" style="cursor:default;">
            <button id="lightboxNext" class="lightbox-nav lightbox-next" onclick="event.stopPropagation(); navigateLightbox(1)" title="Next (‚Üí)">&#10095;</button>
            <div id="lightboxCounter" class="lightbox-counter">1 / 1</div>
        </div>
    </div>

    <script>{{JS_PLACEHOLDER}}</script>
</body>
</html>
